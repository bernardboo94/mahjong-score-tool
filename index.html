<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››äººéº»å°†è®¡ç•ª</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #166534;
        }
        .container {
            background-color: #f0fdf4;
        }
        .card {
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        input, select {
            color: #166534;
        }
        .modal {
            transition: transform 0.3s ease-out;
            transform: translateY(-100%);
        }
        .modal.active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-emerald-800 text-gray-800 flex items-center justify-center min-h-screen p-4">

<div class="container rounded-3xl shadow-2xl p-6 md:p-10 w-full max-w-4xl mx-auto">
    <h1 class="text-3xl md:text-5xl font-extrabold text-white text-center mb-6 drop-shadow-md">
        <span class="text-black drop-shadow-md">ğŸ€„ å››äººéº»å°†è®¡ç•ª ğŸ€„</span>
    </h1>

    <div id="setup-section" class="space-y-6">
        <div class="bg-gray-100 rounded-2xl p-6 shadow-md">
            <label for="price-input" class="block text-xl font-bold mb-2">è®¾ç½®æ¯ç•ªä»·æ ¼</label>
            <input type="number" id="price-input" placeholder="è¾“å…¥æ¯ç•ªä»·æ ¼ï¼ˆä¾‹å¦‚ï¼š10ï¼‰"
                   class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
        </div>

        <div class="bg-gray-100 rounded-2xl p-6 shadow-md">
            <h2 class="text-xl font-bold mb-4">ç©å®¶åå­—</h2>
            <div id="player-inputs" class="space-y-4">
                <input type="text" id="player-1-input" placeholder="ç©å®¶ä¸€" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <input type="text" id="player-2-input" placeholder="ç©å®¶äºŒ" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <input type="text" id="player-3-input" placeholder="ç©å®¶ä¸‰" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <input type="text" id="player-4-input" placeholder="ç©å®¶å››" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
        </div>

        <button onclick="startGame()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300">
            å¼€å§‹æ¸¸æˆ
        </button>
    </div>

    <div id="game-section" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <p class="text-xl font-bold text-gray-700 mb-2 md:mb-0">
                å½“å‰å±€æ•°ï¼š<span id="current-round-text">ä¸œé£åœˆï¼Œä¸œé£å±€</span>
                <br class="md:hidden">
                <span class="md:ml-4">æ¯ç•ªä»·æ ¼ï¼š<span id="per-fan-price-display"></span></span>
            </p>
            <button onclick="showEndGameModal()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300">
                ç»“æŸæ¸¸æˆ
            </button>
        </div>

        <div id="score-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>

        <div class="bg-gray-100 rounded-2xl p-6 shadow-md space-y-4">
            <h2 class="text-xl font-bold mb-2">æœ¬å±€è®°å½•</h2>
            <label for="winner-select" class="block text-md font-medium text-gray-700">èµ¢å®¶</label>
            <select id="winner-select" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="" disabled selected>é€‰æ‹©èµ¢å®¶</option>
            </select>
            
            <label for="pao-select" class="block text-md font-medium text-gray-700">ç‚¹ç‚®è€…</label>
            <select id="pao-select" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="" disabled selected>é€‰æ‹©ç‚¹ç‚®è€…</option>
                <option value="zimo">è‡ªæ‘¸</option>
            </select>

            <label for="fans-input" class="block text-md font-medium text-gray-700">ç•ªæ•°</label>
            <input type="number" id="fans-input" placeholder="èƒ¡äº†å¤šå°‘ç•ªï¼Ÿ" value="1" min="1"
                   class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500">

            <button onclick="recordRound()" id="record-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300">
                è®°å½•æœ¬å±€
            </button>
        </div>

        <div id="history-section" class="mt-8 bg-gray-100 rounded-2xl p-6 shadow-md">
            <h2 class="text-xl font-bold mb-4">å†å²è®°å½•</h2>
            <div id="history-list" class="space-y-2 text-gray-700"></div>
        </div>
    </div>

    <div id="summary-section" class="hidden">
        <div class="bg-gray-100 rounded-2xl p-6 shadow-md space-y-4">
            <h2 class="text-xl md:text-2xl font-bold mb-2 text-center">æ¸¸æˆæ€»ç»“</h2>
            
            <h3 class="text-lg font-bold">æœ€ç»ˆåˆ†æ•°</h3>
            <div id="final-score-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>

            <h3 class="text-lg font-bold mt-6">å®Œæ•´å†å²è®°å½•</h3>
            <div id="final-history-list" class="space-y-2 text-gray-700"></div>
            
            <button onclick="resetGame()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 mt-6">
                æ–°çš„ä¸€å±€
            </button>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
<div id="end-game-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">ç»“æŸæ¸¸æˆï¼Ÿ</h3>
        <p class="text-gray-700 text-center mb-6">ç¡®å®šè¦ç»“æŸæ¸¸æˆå—ï¼Ÿæ‰€æœ‰æ•°æ®éƒ½å°†è¢«æ¸…ç©ºã€‚</p>
        <div class="flex justify-around space-x-4">
            <button onclick="confirmEndGame()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300 w-1/2">
                ç¡®å®š
            </button>
            <button onclick="hideEndGameModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-xl shadow-md transition duration-300 w-1/2">
                å–æ¶ˆ
            </button>
        </div>
    </div>
</div>

<!-- ç©å®¶åå­—é”™è¯¯å¼¹çª— -->
<div id="name-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">è¾“å…¥é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">è¯·è¾“å…¥å…¨éƒ¨ç©å®¶åå­—</p>
        <div class="flex justify-center">
            <button onclick="hideNameErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- é€‰æ‹©é”™è¯¯å¼¹çª— -->
<div id="selection-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">é€‰æ‹©é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">æ‚¨ä¸èƒ½é€‰æ‹©è‡ªå·±ä½œä¸ºç‚¹ç‚®è€…ã€‚</p>
        <div class="flex justify-center">
            <button onclick="hideSelectionErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- æ¯ç•ªä»·æ ¼é”™è¯¯å¼¹çª— -->
<div id="price-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">è¾“å…¥é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">è¯·è¾“å…¥æ¯ç•ªä»·æ ¼</p>
        <div class="flex justify-center">
            <button onclick="hidePriceErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šèµ¢å®¶æœªé€‰å¼¹çª— -->
<div id="winner-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">é€‰æ‹©é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">è¯·é€‰æ‹©èµ¢å®¶ã€‚</p>
        <div class="flex justify-center">
            <button onclick="hideWinnerErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šç‚¹ç‚®è€…æœªé€‰å¼¹çª— -->
<div id="pao-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">é€‰æ‹©é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">è¯·é€‰æ‹©ç‚¹ç‚®è€…ã€‚</p>
        <div class="flex justify-center">
            <button onclick="hidePaoErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šç•ªæ•°è¿‡ä½å¼¹çª— -->
<div id="fans-low-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">ç•ªæ•°é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">æœ€ä½ä¸‰ç•ªèµ·èƒ¡ã€‚</p>
        <div class="flex justify-center">
            <button onclick="hideFansLowErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šç•ªæ•°æ ¼å¼é”™è¯¯å¼¹çª— -->
<div id="fans-decimal-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative bg-white rounded-2xl p-8 shadow-xl mx-4 max-w-sm w-full modal">
        <h3 class="text-xl font-semibold mb-4 text-center">ç•ªæ•°é”™è¯¯</h3>
        <p class="text-gray-700 text-center mb-6">è¯·è¾“å…¥æ­£ç¡®çš„ç•ªæ•°ã€‚</p>
        <div class="flex justify-center">
            <button onclick="hideFansDecimalErrorModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-xl shadow-md transition duration-300">
                ç¡®å®š
            </button>
        </div>
    </div>
</div>

<script>
    let players = {};
    let perFanPrice = 0;
    let round = 0;
    const winds = ["ä¸œé£", "å—é£", "è¥¿é£", "åŒ—é£"];
    let history = [];
    let editingIndex = null;

    function startGame() {
        const priceInput = document.getElementById('price-input').value;
        perFanPrice = parseFloat(priceInput);

        if (isNaN(perFanPrice) || perFanPrice <= 0) {
            showPriceErrorModal();
            return;
        }

        const playerInputs = [
            document.getElementById('player-1-input').value,
            document.getElementById('player-2-input').value,
            document.getElementById('player-3-input').value,
            document.getElementById('player-4-input').value
        ];

        const hasEmptyName = playerInputs.some(name => name.trim() === '');
        if (hasEmptyName) {
            showNameErrorModal();
            return;
        }

        players = {};
        playerInputs.forEach(name => {
            players[name] = 0;
        });

        round = 0;
        history = [];

        document.getElementById('setup-section').classList.add('hidden');
        document.getElementById('game-section').classList.remove('hidden');
        updateGameUI();
    }

    function recordRound() {
        const winner = document.getElementById('winner-select').value;
        const pao = document.getElementById('pao-select').value;
        const fansInput = document.getElementById('fans-input').value;

        // 1. Validate winner
        if (!winner) {
            showWinnerErrorModal();
            return;
        }

        // 2. Validate pao
        if (!pao) {
            showPaoErrorModal();
            return;
        }
        
        // 3. Validate fans
        const fans = parseFloat(fansInput);
        if (isNaN(fans) || fans !== Math.floor(fans)) {
            showFansDecimalErrorModal();
            return;
        }
        if (fans < 3) {
            showFansLowErrorModal();
            return;
        }

        // 4. Existing logic check
        if (winner === pao) {
            showSelectionErrorModal();
            return;
        }
        
        let description = '';
        if (pao === 'zimo' || pao === 'æ— ') {
            description = `${winner} è‡ªæ‘¸ï¼Œå…± ${fans} ç•ªã€‚`;
        } else {
            description = `${winner} èƒ¡äº† ${pao} çš„ç‰Œï¼Œå…± ${fans} ç•ªã€‚`;
        }

        let roundRecord = {
            round: editingIndex !== null ? history[editingIndex].round : round,
            winner: winner,
            fans: fans,
            pao: pao,
            description: description
        };

        if (editingIndex !== null) {
            history[editingIndex] = roundRecord;
            editingIndex = null;
            document.getElementById('record-button').innerText = 'è®°å½•æœ¬å±€';
        } else {
            history.push(roundRecord);
            round++;
        }
        
        recalculateScores();
        updateGameUI();
    }

    function editRound(index) {
        editingIndex = index;
        const record = history[index];
        
        document.getElementById('winner-select').value = record.winner;
        document.getElementById('pao-select').value = record.pao;
        document.getElementById('fans-input').value = record.fans;
        
        document.getElementById('record-button').innerText = 'æ›´æ–°æœ¬å±€';
    }

    function recalculateScores() {
        Object.keys(players).forEach(name => players[name] = 0);

        history.forEach(record => {
            if (record.pao === 'zimo' || record.pao === 'æ— ') {
                const selfDrawAmount = record.fans * perFanPrice * 2;
                players[record.winner] += selfDrawAmount * 3;
                Object.keys(players).forEach(p => {
                    if (p !== record.winner) {
                        players[p] -= selfDrawAmount;
                    }
                });
            } else {
                const paoAmount = record.fans * perFanPrice * 2;
                const otherAmount = record.fans * perFanPrice;
                players[record.winner] += paoAmount + 2 * otherAmount;
                players[record.pao] -= paoAmount;
                Object.keys(players).forEach(p => {
                    if (p !== record.winner && p !== record.pao) {
                        players[p] -= otherAmount;
                    }
                });
            }
        });
    }

    // Modal functions
    function showModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('.modal').classList.add('active');
        }, 10);
    }

    function hideModal(id) {
        const modal = document.getElementById(id);
        modal.querySelector('.modal').classList.remove('active');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    function showEndGameModal() { showModal('end-game-modal'); }
    function hideEndGameModal() { hideModal('end-game-modal'); }
    function confirmEndGame() { hideEndGameModal(); showSummary(); }

    function showNameErrorModal() { showModal('name-error-modal'); }
    function hideNameErrorModal() { hideModal('name-error-modal'); }

    function showSelectionErrorModal() { showModal('selection-error-modal'); }
    function hideSelectionErrorModal() { hideModal('selection-error-modal'); }
    
    function showWinnerErrorModal() { showModal('winner-error-modal'); }
    function hideWinnerErrorModal() { hideModal('winner-error-modal'); }

    function showPaoErrorModal() { showModal('pao-error-modal'); }
    function hidePaoErrorModal() { hideModal('pao-error-modal'); }

    function showFansLowErrorModal() { showModal('fans-low-error-modal'); }
    function hideFansLowErrorModal() { hideModal('fans-low-error-modal'); }

    function showFansDecimalErrorModal() { showModal('fans-decimal-error-modal'); }
    function hideFansDecimalErrorModal() { hideModal('fans-decimal-error-modal'); }

    function showPriceErrorModal() { showModal('price-error-modal'); }
    function hidePriceErrorModal() { hideModal('price-error-modal'); }
    
    function showSummary() {
        document.getElementById('game-section').classList.add('hidden');
        document.getElementById('summary-section').classList.remove('hidden');
        
        const finalScoreDisplay = document.getElementById('final-score-display');
        finalScoreDisplay.innerHTML = '';
        Object.keys(players).forEach(name => {
            const score = players[name];
            const bgColorClass = score >= 0 ? 'bg-[#3CB043]' : 'bg-red-500';
            const cardHtml = `
                <div class="rounded-2xl p-4 text-center shadow-lg ${bgColorClass}">
                    <p class="font-bold text-white text-lg">${name}</p>
                    <p class="font-extrabold text-2xl mt-2 text-black">${score.toFixed(2)}</p>
                </div>
            `;
            finalScoreDisplay.innerHTML += cardHtml;
        });

        const finalHistoryList = document.getElementById('final-history-list');
        finalHistoryList.innerHTML = '';
        history.forEach(record => {
            finalHistoryList.innerHTML += `<p class="border-b border-gray-300 pb-2 mb-2"><strong>${record.description}</strong></p>`;
        });
    }

    function resetGame() {
        document.getElementById('summary-section').classList.add('hidden');
        document.getElementById('setup-section').classList.remove('hidden');
        document.getElementById('price-input').value = '';
        document.getElementById('player-1-input').value = '';
        document.getElementById('player-2-input').value = '';
        document.getElementById('player-3-input').value = '';
        document.getElementById('player-4-input').value = '';
    }

    function updateGameUI() {
        const scoreDisplay = document.getElementById('score-display');
        scoreDisplay.innerHTML = '';
        const winnerSelect = document.getElementById('winner-select');
        const paoSelect = document.getElementById('pao-select');
        winnerSelect.innerHTML = '<option value="" disabled selected>é€‰æ‹©èµ¢å®¶</option>';
        paoSelect.innerHTML = '<option value="" disabled selected>é€‰æ‹©ç‚¹ç‚®è€…</option><option value="zimo">è‡ªæ‘¸</option>';
        
        Object.keys(players).forEach(name => {
            const score = players[name];
            const bgColorClass = score >= 0 ? 'bg-[#3CB043]' : 'bg-red-500';
            const cardHtml = `
                <div class="rounded-2xl p-4 text-center shadow-lg ${bgColorClass}">
                    <p class="font-bold text-white text-lg">${name}</p>
                    <p class="font-extrabold text-2xl mt-2 text-black">${score.toFixed(2)}</p>
                </div>
            `;
            scoreDisplay.innerHTML += cardHtml;
            
            winnerSelect.innerHTML += `<option value="${name}">${name}</option>`;
            paoSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });

        document.getElementById('current-round-text').innerText = `ç¬¬${Math.floor(round / 4) + 1}åœˆï¼Œ${winds[round % 4]}å±€`;
        document.getElementById('per-fan-price-display').innerText = `${perFanPrice}`;

        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        history.forEach((record, index) => {
            const displayRound = `ç¬¬${Math.floor(record.round / 4) + 1}åœˆï¼Œ${winds[record.round % 4]}å±€`;
            historyList.innerHTML += `
                <div class="flex justify-between items-center border-b border-gray-300 pb-2 mb-2">
                    <p><strong>${displayRound}</strong>ï¼š${record.description}</p>
                    <button onclick="editRound(${index})" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-xl shadow-md transition duration-300 text-sm">ç¼–è¾‘</button>
                </div>
            `;
        });
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
                console.log('Service Worker registered: ', registration);
            }).catch(registrationError => {
                console.log('Service Worker registration failed: ', registrationError);
            });
        });
    }

</script>
</body>
</html>

